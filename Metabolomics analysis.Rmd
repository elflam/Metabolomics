---
title: "Metabolomics analysis"
author: "Emily Flam"
date: "February 22, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Create function to normalize data
Normalization will be within sample by median (scaled so median metabolite value equals 1)
```{R}

##Function to normalize to median of a vector
MedianNorm <- function(datVec){
  NormVec <- datVec / median(datVec)
  return(NormVec)
}

##Function to normalize each column of a dataframe and combine original and normalized columns into one dataframe 
DataNorm <- function(datFrame){
  #Run normalization on each row of data frame to create second dataframe
  Norm <-apply(datFrame,2,MedianNorm)
  #Edit colnames to include normalization
  colnames(Norm) <- paste0(colnames(Norm),"_Norm")
  #combine original and normalized columns together
  ComboDat <- cbind(datFrame, Norm)
  #sort rows so that sample columns cluster together
  ComboDat <- ComboDat[,order(colnames(ComboDat))]
  return(ComboDat)
}

##Function to run t-test HF vs NF on normalized metabolomics data 
##Correct 
Tmet <- function(normDat){
  #grab normalized columns
  Norms <- normDat[,grep("Norm", colnames(normDat))]
  #Make new row with HF status
  Norms <- rbind(Norms, c(sapply(strsplit(colnames(Norms), split="_"), function(x){x[[1]]})))
  rownames(Norms)[nrow(Norms)] <- "Disease"
  #transpose table
  Norms <- as.data.frame(t(Norms))
  #t test
  Tvec <- numeric()
  for (i in 1:(ncol(Norms)-1)){
    tmpvec <- as.numeric(Norms[,i])
    names(tmpvec) <- as.character(Norms$Disease)
    Tvec[i] <- t.test(tmpvec[which(names(tmpvec) == "HF")],tmpvec[which(names(tmpvec) == "NF")])$p.value
  }
  #FDR correction
  Tvec <- p.adjust(Tvec, method = "fdr")
  names(Tvec) <- colnames(Norms)[1:(ncol(Norms)-1)]
  return(Tvec)
}

Wilcox <- function(normDat){
  Norms <- normDat[,grep("Norm", colnames(normDat))]
  #Make new row with HF status
  Norms <- rbind(Norms, c(sapply(strsplit(colnames(Norms), split="_"), function(x){x[[1]]})))
  rownames(Norms)[nrow(Norms)] <- "Disease"
  #transpose table
  Norms <- as.data.frame(t(Norms))
  #wilcox test
  Wvec <- numeric()
  for (i in 1:(ncol(Norms)-1)){
    tmpvec <- as.numeric(Norms[,i])
    names <- as.character(Norms$Disease)
    Wvec[i] <- wilcox.test(tmpvec ~ names)$p.value
  }
  Wvec <- p.adjust(Tvec, method = "fdr")
  names(Wvec) <- colnames(Norms)[1:(ncol(Norms)-1)]
  return(Wvec)
}


```

import data
```{R}
#Set working directory
setwd("C:/Users/Emily/Desktop/Box Sync/Data/Human HF cohort")
#Load file
metabolomics <- read.csv("010319(HILIC emily human heart patient 1007-1635).csv", header=TRUE, sep=",",quote="",na.strings="", comment.char="", stringsAsFactors = FALSE)
DiseaseID <- read.csv("HumanHFcohortDiseaseIds.csv", header=TRUE, sep=",",quote="",na.strings="", comment.char="", stringsAsFactors = FALSE)

#remove any columns with suspected sample degradation - change loop vector to specify which columns
for (i in c(3,7)){
  metabolomics <- metabolomics[,-i]
}
```
Assign disease status to sample labels
```{R}

HFsamp <- sapply(DiseaseID$Sample[which(DiseaseID$CHF.Etiology != "NF")], function(x){grep(x,colnames(metabolomics), value=TRUE)})
NFsamp <- sapply(DiseaseID$Sample[which(DiseaseID$CHF.Etiology == "NF")], function(x){grep(x,colnames(metabolomics), value=TRUE)})

colnames(metabolomics)[which(colnames(metabolomics) %in% HFsamp)] <- sapply(colnames(metabolomics)[which(colnames(metabolomics) %in% HFsamp)], function(x){paste0("HF_",x)}) 

colnames(metabolomics)[which(colnames(metabolomics) %in% NFsamp)] <- sapply(colnames(metabolomics)[which(colnames(metabolomics) %in% NFsamp)], function(x){paste0("NF_",x)}) 
```

Format Data
```{R}
#rename columns so that metabolite info will not be lost when redundant sample label rows are removed
#First metabolite name is inappropriately assigned to first column name. Must move this metabolite manually before adjusting all others
metabolomics[1,1] <- colnames(metabolomics)[1]
colnames(metabolomics)[1] <- "metabolite"

#Split metabolomics table into positive and negative modes
## change to remove row
PosNegSplit <- as.numeric(rownames(metabolomics[which(metabolomics$metabolite == 'positive mode'),]))
NegativeMode <- metabolomics[1:(PosNegSplit-1),]
PositiveMode <- metabolomics[(PosNegSplit+1):nrow(metabolomics),]

#Replace "Parent C12" with metabolite name so that association is not lost when redundant label rows are deleted
#negativeMode first because I have already done this for one row
NegativeMode[which(as.numeric(rownames(NegativeMode)) %% 2 != 0 & as.numeric(rownames(NegativeMode))>1),1] <-   NegativeMode[which(as.numeric(rownames(NegativeMode)) %% 2 == 0),1]
#remove redundant sample ID rows (currently every other row)
NegativeMode <- NegativeMode[which(as.numeric(rownames(NegativeMode)) %% 2 != 0),]
#Remove any redundant rows; assumes that the rows are together in dataframe
NegativeMode <- NegativeMode[which(duplicated(NegativeMode) == FALSE),]
#Make metabolite rownames and delete first column
rownames(NegativeMode) <- NegativeMode$metabolite
NegativeMode <- NegativeMode[,-1]

#Repeat for positive mode
#negativeMode first because I have already done this for one row
PositiveMode[which(as.numeric(rownames(PositiveMode)) %% 2 == 0),1] <-   PositiveMode[which(as.numeric(rownames(PositiveMode)) %% 2 != 0),1]
#remove redundant sample ID rows (currently every other row)
PositiveMode <- PositiveMode[which(as.numeric(rownames(PositiveMode)) %% 2 == 0),]
#Make metabolite rownames and delete first column
PositiveMode <- PositiveMode[,-1]
#Remove any redundant rows; assumes that the rows are together in dataframe
PositiveMode <- PositiveMode[which(duplicated(PositiveMode) == FALSE),]
#Make metabolite rownames and delete first column
rownames(PositiveMode) <- PositiveMode$metabolite
PositiveMode <- PositiveMode[,-1]

```


Normalize data and run t test
```{R}

NegNorm <- DataNorm(NegativeMode)
PosNorm <- DataNorm(PositiveMode)

NegT <- Tmet(NegNorm)
NegTDif <- NegT[which(NegT < 0.05)]

NegW <- Wilcox(NegNorm)
NegWDif <- NegW[which(NegW < 0.05)]


```
