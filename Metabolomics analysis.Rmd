---
title: "Metabolomics analysis"
author: "Emily Flam"
date: "February 22, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

import data
```{R}
#Set working directory
setwd("C:/Users/Emily/Desktop/Box Sync/Data/Human HF cohort")
#Load file
metabolomics <- read.csv("010319(HILIC emily human heart patient 1007-1635).csv", header=TRUE, sep=",",quote="",na.strings="", comment.char="", stringsAsFactors = FALSE)
```

Format Data
```{R}
#rename columns so that metabolite info will not be lost when redundant sample label rows are removed
#First metabolite name is inappropriately assigned to first column name. Must move this metabolite manually before adjusting all others
metabolomics[1,1] <- colnames(metabolomics)[1]
colnames(metabolomics)[1] <- "metabolite"

#Split metabolomics table into positive and negative modes
PosNegSplit <- as.numeric(rownames(metabolomics[which(metabolomics$metabolite == 'positive mode'),]))
NegativeMode <- metabolomics[1:(PosNegSplit-1),]
PositiveMode <- metabolomics[(PosNegSplit+1):nrow(metabolomics),]

#Replace "Parent C12" with metabolite name so that association is not lost when redundant label rows are deleted
#negativeMode first because I have already done this for one row
NegativeMode[which(as.numeric(rownames(NegativeMode)) %% 2 != 0 & as.numeric(rownames(NegativeMode))>1),1] <-   NegativeMode[which(as.numeric(rownames(NegativeMode)) %% 2 == 0),1]
#remove redundant sample ID rows (currently every other row)
NegativeMode <- NegativeMode[which(as.numeric(rownames(NegativeMode)) %% 2 != 0),]
#Remove any redundant rows; assumes that the rows are together in dataframe
NegativeMode <- NegativeMode[which(duplicated(NegativeMode) == FALSE),]
#Make metabolite rownames and delete first column
rownames(NegativeMode) <- NegativeMode$metabolite
NegativeMode <- NegativeMode[,-1]

#Repeat for positive mode
#negativeMode first because I have already done this for one row
PositiveMode[which(as.numeric(rownames(PositiveMode)) %% 2 == 0),1] <-   PositiveMode[which(as.numeric(rownames(PositiveMode)) %% 2 != 0),1]
#remove redundant sample ID rows (currently every other row)
PositiveMode <- PositiveMode[which(as.numeric(rownames(PositiveMode)) %% 2 == 0),]
#Make metabolite rownames and delete first column
PositiveMode <- PositiveMode[,-1]
#Remove any redundant rows; assumes that the rows are together in dataframe
PositiveMode <- PositiveMode[which(duplicated(PositiveMode) == FALSE),]
#Make metabolite rownames and delete first column
rownames(PositiveMode) <- PositiveMode$metabolite
PositiveMode <- PositiveMode[,-1]

```

Create function to normalize Negative Mode data
Normalization will be within sample by median (scaled so median metabolite value equals 1)
```{R}

NegNorm <- function(Neg_dat){
  #Create a matrix with twice the columns of original data matrix to store normalized data for each sample
  #NegativeModeNorm <- matrix(nrow=nrow(as.matrix(Neg_dat)), ncol=ncol(as.matrix(Neg_dat))*2, dimnames = list(NULL,rep(colnames(Neg_dat), each=2)))

  #remove first column and copy metabolite column from original matrix; metabolite names will not need normalized column
  #NegativeModeNorm <- NegativeModeNorm[,-1]
  #NegativeModeNorm[,1] <- Neg_dat[,1]
  
  #Copy all other columns and put into even columns of new matrix
  #NegativeModeNorm[ ,which(c(2:ncol(NegativeModeNorm) %% 2 == 0))] <- Neg_dat[,2:ncol(Neg_dat)]
  
  Norm <-apply(Neg_dat[,-1])
  
}

```


